<?php
error_reporting(E_ERROR);
ini_set('max_execution_time', 0);

define("SAFE_COOKIE", "PREF=ID=6300bfd1b977038f:U=f9795c89f3841505:FF=0:LD=en:TM=1380723039:LM=1397227853:GM=1:S=2xOg1fJ8FoxzUM6d; OGPC=4061135-2:; NID=67=GL3W8NSSXdtAQ5bvp-04aSY9yinECQZCg3BisxGTgiZZ960KIkZgBRpPeWbEy1PtmddRCRtDJu2CsDqMNHJ3kX_clsfblBS5gazzC76IyDdgeMGK3uH-8SGrtgleKZrBP6Az66F6cT5wn88AU0wVu7NW5PaEEn4SIoGKQD_XUH544rWl1oHXAN7IYKx6bZqXMWtg__ceBmG8GJDe1cRlhxskPqqzLP-pAbP_cgUYZ2rcUvIN; HSID=Aq-B46d9LLRMjTarP; APISID=UH_6nQNs7ngX9moL/A874AeSSbWY0V5VcW; SID=DQAAANEAAACRLtuaDkm1rWd8E71FScgFV2X_YpyauDIvPy5-G8bSLL7k4x6qPpy0ErbN8IlgGOi-7UPdU6stJ9a_NiBpUsoa2HMND6b2zyRK8O31UPlUbAaHt_98dFhEUTziQEdoORcUeM-Y1j-W8KJsgpoH5Cesnv-V3vvMJ8durygNlgHCUeEApPNMLgC-SIF1CFykNZH7R20QLzP4pY7Kt021SpFGlkLcxpOY8Ym0jxCl8cdCuoRhVATcX8oVL2JO2pCoGaT2Nd6baAbVig2tnEKoOeQreo7D1qGJGZRSjLp6O-BB4g; GOOGLE_ABUSE_EXEMPTION=ID=c25cb465d77c6529:TM=1402598188:C=c:IP=58.187.41.233-:S=APGng0smUVo1aXruHG7yIaTK5U2pf33cKg");
define("DATA_FILE", "data.txt");
define("EXCEL_FOLDER", "excels");
define("MIN_DELAY_TIME", 10);
define("MAX_DELAY_TIME", 30);

// ini_set('user_agent', 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.114 Safari/537.36');

include_once('../simple_html_dom.php');
include_once('../functions.php');

function scraping_server($url) {

	$list_url = array();
	// create HTML DOM
    $html = str_get_html(mycrawler($url, SAFE_COOKIE, 60));
	if(!$html) {
		echo "Deo hieu 1: $url\n"; 
		return $list_url;
	} 
	foreach($html->find('a') as $element) {
		$url = $element->href;
		if($url != '#' && $url != 'http://www.google.com/') {
			$malware_site = check_malware_site("http://safebrowsing.clients.google.com" . $url);
			if($malware_site !== false) {
				$list_url[] = $malware_site;
			}
		}
	}
    
    // clean up memory
    $html->clear();
    unset($html);
	
	return $list_url;
}

function check_malware_site($url) {
	// echo $url . '<br>';
	
    $html = str_get_html(mycrawler($url, SAFE_COOKIE, 60));
	sleep(rand(MIN_DELAY_TIME, MAX_DELAY_TIME));
	if(!$html) {
		echo "Deo hieu 2 $url \n"; 
		return false;
	}
    $malcontent = $html->find('blockquote', 0)->plaintext;
	
	if(strpos($malcontent, 'Site is listed as suspicious - visiting this web site may harm your computer') !== false) {
		$parts = parse_url($url);
		parse_str($parts['query'], $query);	
		$site_url = $query['site'] ? $query['site'] : $query['amp;site'];
		
		return $site_url;
	} else {
		echo "No malware : " . $url . "\n";
		return false;
	}
    
    $html->clear();
    unset($html);
}

function extractInfo($content) {
	$result['phone'] = '';
	$result['email'] = '';
	
	foreach(explode("<br/>", $content) as $line) {
		$tmp = explode(":", $line);
		if(strpos($tmp[0], 'Organization') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['company'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(!$result['company'] && strpos($tmp[0], 'Name') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['company'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'Street') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['street'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'City') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['city'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'State') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['state'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'Country') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['country'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'Postal') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			$result['postal_code'] = str_replace("&nbsp;", " ", $tmp[1]);
		}
		
		if(strpos($tmp[0], 'Phone') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			if(strpos($result['phone'], str_replace("&nbsp;", " ", $tmp[1])) === false) {
				$result['phone'] .= (str_replace("&nbsp;", " ", $tmp[1]) . '    ');
			}
		}
		
		if(strpos($tmp[0], 'Email') !== false && trim(str_replace("&nbsp;", " ", $tmp[1])) != '') {
			if(strpos($result['email'], str_replace("&nbsp;", " ", $tmp[1])) === false) {
				$result['email'] .= (str_replace("&nbsp;", " ", $tmp[1]) . '    ');
			}
		}
		
		// echo $line . '<br>';
	}
	
	return $result;
}

function printExcel($list_url) {
	require_once("../PHPExcel.php");	
	require_once('../PHPExcel/Writer/Excel2007.php');
	$phpExcel = new PHPExcel();
	$sheet = $phpExcel->getActiveSheet();
	
	$rowCounter = 1;
	$sheet->setCellValue("A$rowCounter", "No.")
		->setCellValue("B$rowCounter", 'Site')
		->setCellValue("C$rowCounter", 'Company')
		->setCellValue("D$rowCounter", 'Street')
		->setCellValue("E$rowCounter", 'City')
		->setCellValue("F$rowCounter", 'State')
		->setCellValue("G$rowCounter", 'Country')
		->setCellValue("H$rowCounter", 'Postal code')
		->setCellValue("I$rowCounter", 'Email')
		->setCellValue("J$rowCounter", 'Phone');
	$rowCounter++;
		
	foreach($list_url as $single_site) {
		// echo $single_site . "-->" . getRootDomain($single_site) . "\n";
		if(getRootDomain($single_site) === false) continue;
		
		$html = str_get_html(mycrawler("http://www.networksolutions.com/whois/results.jsp?domain=" . getRootDomain($single_site), SAFE_COOKIE, 60));
		$info = $html->find('div.content', 0)->innertext;	
		$info = delUntilMeet($info, "<br/>");
		$info = getUntilMeet($info, "</td>");
		
		$excel_row = extractInfo($info);
		
		if($excel_row['company'] || $excel_row['street'] || $excel_row['city'] || $excel_row['state'] || $excel_row['country'] || $excel_row['postal_code'] || $excel_row['phone'] || $excel_row['email']) {
			$excel_row['site'] = getRootDomain($single_site);
			printExcelRow($sheet, $rowCounter++, $excel_row);
		}
	}
	
	$a2z = array("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z");
	foreach($a2z as $letter) $sheet->getColumnDimension("$letter")->setAutoSize(true);
	
	//Wrap long fields
	$sheet->getStyle("A2:Z1")->getAlignment()->setWrapText(true);
	
	//Set the active sheet to the first sheet before outputting. This is only needed if you want to ensure the file is opened on the first sheet.
	$phpExcel->setActiveSheetIndex(0);
	
	// Save Excel 2007 file
	echo date('H:i:s') . " Write to Excel2007 format\n";
	$objWriter = new PHPExcel_Writer_Excel2007($phpExcel);
	$date = new DateTime();
	$objWriter->save(EXCEL_FOLDER . '/' . $date->format("y-m-d") . '_file_' . $date->format("U") . '.xlsx');

	// Echo done
	echo date('H:i:s') . " Done writing file.\r\n";
	exit();
}

function printExcelRow($sheet, $rowCounter, $result) {
	
	$sheet->setCellValue("A$rowCounter", $rowCounter-1)
		->setCellValue("B$rowCounter", $result['site'])
		->setCellValue("C$rowCounter", $result['company'])
		->setCellValue("D$rowCounter", $result['street'])
		->setCellValue("E$rowCounter", $result['city'])
		->setCellValue("F$rowCounter", $result['state'])
		->setCellValue("G$rowCounter", $result['country'])
		->setCellValue("H$rowCounter", $result['postal_code'])
		->setCellValue("I$rowCounter", $result['email'])
		->setCellValue("J$rowCounter", $result['phone']);
}

// -----------------------------------------------------------------------------
restart:
if(file_exists(DATA_FILE)) {
	$used_array = file(DATA_FILE, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
	$handle = fopen(DATA_FILE, 'a') or die('Cannot open file:  '. DATA_FILE);
} else {
	$used_array = array();
	$handle = fopen(DATA_FILE, 'w') or die('Cannot open file:  '. DATA_FILE);
}

//Write data here
$total_arr = range(1, 58993);
$remain_arr = array_diff($total_arr, $used_array);
if( empty( $remain_arr ) )
{
	echo "Need to restart\n";
	$handle = fopen(DATA_FILE, 'w') or die('Cannot open file:  '. DATA_FILE);
	fwrite($handle, 0);
	if($handle) fclose($handle);
	goto restart; 
}

$list_url = array();
foreach(getRandomNumbers($remain_arr, 500) as $number) {
	fwrite($handle, PHP_EOL . $number);
	$new_list = scraping_server('http://safebrowsing.clients.google.com/safebrowsing/diagnostic?&hl=en&site=AS:' . $number);
	sleep(rand(MIN_DELAY_TIME, MAX_DELAY_TIME));
	$list_url = array_merge((array)$list_url, (array)$new_list);
}

if($handle) fclose($handle);

// print_r($list_url);
printExcel($list_url);

// printExcel(array_merge($list_url, array
// (
    // "kitanotakumi.jj.cx",
    // "prazdnikdushi.ru",
    // "prazdnikdushi.ru",
    // "heslegaard.dk",
    // "klitheden.dk",
    // "kenkyissd.info",
    // "kenkyissd.net",
    // "kenkyissd.com",
    // "odtoidcwe.info"
// )));

?>